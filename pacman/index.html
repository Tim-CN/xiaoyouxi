<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒè±†äºº - ZZXå°æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .game-container {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            border-radius: 4px;
            color: white;
        }
        
        .score-container, .lives-container, .level-container {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .score-container::before {
            content: 'ğŸ†';
            margin-right: 0.5rem;
        }
        
        .lives-container::before {
            content: 'â¤ï¸';
            margin-right: 0.5rem;
        }
        
        .level-container::before {
            content: 'ğŸš©';
            margin-right: 0.5rem;
        }
        
        #game-canvas {
            border: 2px solid #6a11cb;
            border-radius: 4px;
            background-color: #000;
            display: block;
            margin: 0 auto;
            image-rendering: pixelated;
        }
        
        .controls {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1.5rem;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .mobile-controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            margin-top: 1rem;
            max-width: 150px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mobile-btn {
            width: 50px;
            height: 50px;
            background: rgba(106, 17, 203, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .mobile-btn:active {
            background: rgba(37, 117, 252, 0.9);
        }
        
        .up-btn {
            grid-column: 2;
            grid-row: 1;
        }
        
        .left-btn {
            grid-column: 1;
            grid-row: 2;
        }
        
        .right-btn {
            grid-column: 3;
            grid-row: 2;
        }
        
        .down-btn {
            grid-column: 2;
            grid-row: 3;
        }
        
        .instructions {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f0f0f0;
            border-radius: 4px;
            text-align: left;
        }
        
        .instructions h3 {
            margin-bottom: 0.5rem;
            color: #6a11cb;
        }
        
        .instructions ul {
            list-style-position: inside;
            padding-left: 1rem;
        }
        
        .instructions li {
            margin-bottom: 0.5rem;
        }
        
        .key-bindings {
            display: grid;
            grid-template-columns: auto auto;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .key {
            background: #ddd;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        
        .back-btn {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 0.5rem 1.5rem;
            background: #666;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: #555;
        }
        
        footer {
            text-align: center;
            padding: 1.5rem;
            background-color: #333;
            color: #fff;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .logo {
                font-size: 1.5rem;
            }
            
            #game-canvas {
                width: 100%;
                height: auto;
            }
            
            .mobile-controls {
                display: grid;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">åƒè±†äººæ¸¸æˆ</div>
        <div class="subtitle">ZZXå°æ¸¸æˆåˆé›†</div>
    </header>
    
    <div class="container">
        <div class="game-container">
            <div class="game-header">
                <div class="score-container">åˆ†æ•°: <span id="score">0</span></div>
                <div class="lives-container">ç”Ÿå‘½: <span id="lives">3</span></div>
                <div class="level-container">å…³å¡: <span id="level">1</span></div>
            </div>
            
            <canvas id="game-canvas" width="448" height="496"></canvas>
            
            <div class="mobile-controls">
                <button class="mobile-btn up-btn">â†‘</button>
                <button class="mobile-btn left-btn">â†</button>
                <button class="mobile-btn right-btn">â†’</button>
                <button class="mobile-btn down-btn">â†“</button>
            </div>
            
            <div class="controls">
                <button id="start-btn" class="btn">å¼€å§‹æ¸¸æˆ</button>
                <button id="pause-btn" class="btn" disabled>æš‚åœ</button>
                <button id="reset-btn" class="btn">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
        
        <div class="instructions">
            <h3>æ¸¸æˆè¯´æ˜:</h3>
            <ul>
                <li>ä½¿ç”¨æ–¹å‘é”®æˆ–WASDæ§åˆ¶åƒè±†äººç§»åŠ¨</li>
                <li>åƒæ‰æ‰€æœ‰è±†å­å³å¯é€šå…³</li>
                <li>é¿å¼€å¹½çµï¼Œå¦åˆ™ä¼šå¤±å»ç”Ÿå‘½</li>
                <li>åƒæ‰å¤§åŠ›ä¸¸åå¯ä»¥æš‚æ—¶åƒæ‰å¹½çµ</li>
                <li>æ¯å…³éš¾åº¦ä¼šå¢åŠ </li>
                <li>è·å¾—é«˜åˆ†è¿›å…¥æ’è¡Œæ¦œ!</li>
            </ul>
            
            <div class="key-bindings">
                <div class="key">â†/â†’/â†‘/â†“</div>
                <div>ç§»åŠ¨åƒè±†äºº</div>
                <div class="key">W/A/S/D</div>
                <div>ç§»åŠ¨åƒè±†äºº</div>
                <div class="key">P</div>
                <div>æš‚åœ/ç»§ç»­</div>
                <div class="key">ç©ºæ ¼é”®</div>
                <div>å¼€å§‹æ¸¸æˆ</div>
            </div>
        </div>
        
        <a href="../å°æ¸¸æˆ.html" class="back-btn">è¿”å›æ¸¸æˆå¤§å…</a>
    </div>
    
    <footer>
        <p>Â© 2025 ZZXå°æ¸¸æˆ | ä½œè€…ï¼šZZX | æ‰€æœ‰æ¸¸æˆç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const scoreElement = document.getElementById('score');
            const livesElement = document.getElementById('lives');
            const levelElement = document.getElementById('level');
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const upBtn = document.querySelector('.up-btn');
            const downBtn = document.querySelector('.down-btn');
            const leftBtn = document.querySelector('.left-btn');
            const rightBtn = document.querySelector('.right-btn');
            
            // æ¸¸æˆé…ç½®
            const CELL_SIZE = 16;
            const GRID_WIDTH = 28;
            const GRID_HEIGHT = 31;
            const PACMAN_SPEED = 2;
            const GHOST_SPEED = 1.5;
            const POWER_PELLET_DURATION = 300; // å¤§åŠ›ä¸¸æ•ˆæœæŒç»­æ—¶é—´ï¼ˆå¸§æ•°ï¼‰
            
            // åœ°å›¾å®šä¹‰ (0: ç©º, 1: å¢™, 2: è±†å­, 3: å¤§åŠ›ä¸¸, 4: å¹½çµå‡ºç”Ÿç‚¹, 5: åƒè±†äººå‡ºç”Ÿç‚¹)
            const levelMap = [
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1],
                [1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1],
                [1, 3, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 3, 1],
                [1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1],
                [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1],
                [1, 2, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 2, 1],
                [1, 2, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 2, 1],
                [1, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 1],
                [1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1],
                [0, 0, 0, 0, 0, 1, 2, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 2, 1, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 1, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 1, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 1, 2, 1, 1, 0, 1, 1, 1, 4, 4, 1, 1, 1, 0, 1, 1, 2, 1, 0, 0, 0, 0, 0],
                [1, 1, 1, 1, 1, 1, 2, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 2, 1, 1, 1, 1, 1, 1],
                [0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0],
                [1, 1, 1, 1, 1, 1, 2, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 2, 1, 1, 1, 1, 1, 1],
                [0, 0, 0, 0, 0, 1, 2, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 2, 1, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 1, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 1, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 1, 2, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 2, 1, 0, 0, 0, 0, 0],
                [1, 1, 1, 1, 1, 1, 2, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 2, 1, 1, 1, 1, 1, 1],
                [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1],
                [1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1],
                [1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1],
                [1, 3, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 5, 0, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 3, 1],
                [1, 1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 1],
                [1, 1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 1],
                [1, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 1],
                [1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1],
                [1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1],
                [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1],
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            ];
            
            // æ¸¸æˆçŠ¶æ€
            let map = [];
            let pacman = {
                x: 0,
                y: 0,
                direction: 'right',
                nextDirection: 'right',
                mouthOpen: true,
                mouthAngle: 0
            };
            let ghosts = [];
            let dots = 0;
            let score = 0;
            let lives = 3;
            let level = 1;
            let powerPelletActive = false;
            let powerPelletTimer = 0;
            let gameRunning = false;
            let gameOver = false;
            let animationFrameId = null;
            
            // åˆå§‹åŒ–æ¸¸æˆ
            function initGame() {
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                score = 0;
                lives = 3;
                level = 1;
                powerPelletActive = false;
                powerPelletTimer = 0;
                gameRunning = false;
                gameOver = false;
                
                // æ›´æ–°æ˜¾ç¤º
                scoreElement.textContent = score;
                livesElement.textContent = lives;
                levelElement.textContent = level;
                
                // åˆå§‹åŒ–åœ°å›¾
                loadLevel();
                
                // ç»˜åˆ¶åˆå§‹çŠ¶æ€
                draw();
                
                // å¯ç”¨å¼€å§‹æŒ‰é’®
                startBtn.disabled = false;
                pauseBtn.disabled = true;
            }
            
            // åŠ è½½å…³å¡
            function loadLevel() {
                // å¤åˆ¶åœ°å›¾
                map = JSON.parse(JSON.stringify(levelMap));
                dots = 0;
                
                // è®¡ç®—è±†å­æ•°é‡å¹¶æ‰¾åˆ°åƒè±†äººå’Œå¹½çµçš„åˆå§‹ä½ç½®
                let pacmanSpawn = null;
                let ghostSpawns = [];
                
                for (let y = 0; y < GRID_HEIGHT; y++) {
                    for (let x = 0; x < GRID_WIDTH; x++) {
                        if (map[y][x] === 2 || map[y][x] === 3) {
                            dots++;
                        } else if (map[y][x] === 5) {
                            pacmanSpawn = { x, y };
                            map[y][x] = 0; // æ¸…ç©ºåƒè±†äººå‡ºç”Ÿç‚¹
                        } else if (map[y][x] === 4) {
                            ghostSpawns.push({ x, y });
                            map[y][x] = 0; // æ¸…ç©ºå¹½çµå‡ºç”Ÿç‚¹
                        }
                    }
                }
                
                // è®¾ç½®åƒè±†äººä½ç½®
                if (pacmanSpawn) {
                    pacman.x = pacmanSpawn.x;
                    pacman.y = pacmanSpawn.y;
                }
                
                // åˆ›å»ºå¹½çµ
                ghosts = [];
                const ghostColors = ['#FF0000', '#FFB8FF', '#00FFFF', '#FFB852'];
                const ghostNames = ['Blinky', 'Pinky', 'Inky', 'Clyde'];
                
                for (let i = 0; i < Math.min(ghostSpawns.length, 4); i++) {
                    ghosts.push({
                        x: ghostSpawns[i].x,
                        y: ghostSpawns[i].y,
                        color: ghostColors[i],
                        name: ghostNames[i],
                        direction: 'left',
                        speed: GHOST_SPEED + (level * 0.1),
                        isScared: false
                    });
                }
            }
            
            // ç»˜åˆ¶æ¸¸æˆ
            function draw() {
                // æ¸…ç©ºç”»å¸ƒ
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶åœ°å›¾
                for (let y = 0; y < GRID_HEIGHT; y++) {
                    for (let x = 0; x < GRID_WIDTH; x++) {
                        const cell = map[y][x];
                        const px = x * CELL_SIZE;
                        const py = y * CELL_SIZE;
                        
                        if (cell === 1) {
                            // å¢™
                            ctx.fillStyle = '#2233AA';
                            ctx.fillRect(px, py, CELL_SIZE, CELL_SIZE);
                        } else if (cell === 2) {
                            // è±†å­
                            ctx.fillStyle = '#FFF';
                            ctx.beginPath();
                            ctx.arc(px + CELL_SIZE / 2, py + CELL_SIZE / 2, 2, 0, Math.PI * 2);
                            ctx.fill();
                        } else if (cell === 3) {
                            // å¤§åŠ›ä¸¸
                            ctx.fillStyle = '#FFF';
                            ctx.beginPath();
                            ctx.arc(px + CELL_SIZE / 2, py + CELL_SIZE / 2, 5, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
                
                // ç»˜åˆ¶åƒè±†äºº
                drawPacman();
                
                // ç»˜åˆ¶å¹½çµ
                drawGhosts();
            }
            
            // ç»˜åˆ¶åƒè±†äºº
            function drawPacman() {
                const px = pacman.x * CELL_SIZE;
                const py = pacman.y * CELL_SIZE;
                
                ctx.fillStyle = '#FF0';
                ctx.beginPath();
                
                // æ ¹æ®å˜´å·´å¼€åˆçŠ¶æ€è®¡ç®—è§’åº¦
                const angle = pacman.mouthOpen ? Math.PI / 4 : 0;
                let startAngle, endAngle;
                
                switch (pacman.direction) {
                    case 'right':
                        startAngle = angle;
                        endAngle = Math.PI * 2 - angle;
                        break;
                    case 'left':
                        startAngle = Math.PI + angle;
                        endAngle = Math.PI - angle;
                        break;
                    case 'up':
                        startAngle = Math.PI * 1.5 + angle;
                        endAngle = Math.PI * 1.5 - angle;
                        break;
                    case 'down':
                        startAngle = Math.PI * 0.5 + angle;
                        endAngle = Math.PI * 0.5 - angle;
                        break;
                }
                
                ctx.arc(
                    px + CELL_SIZE / 2,
                    py + CELL_SIZE / 2,
                    CELL_SIZE / 2,
                    startAngle,
                    endAngle
                );
                ctx.lineTo(px + CELL_SIZE / 2, py + CELL_SIZE / 2);
                ctx.fill();
            }
            
            // ç»˜åˆ¶å¹½çµ
            function drawGhosts() {
                for (const ghost of ghosts) {
                    const px = ghost.x * CELL_SIZE;
                    const py = ghost.y * CELL_SIZE;
                    
                    // ç»˜åˆ¶å¹½çµèº«ä½“
                    ctx.fillStyle = ghost.isScared ? '#00F' : ghost.color;
                    
                    // å¹½çµèº«ä½“ï¼ˆåŠåœ†+çŸ©å½¢ï¼‰
                    ctx.beginPath();
                    ctx.arc(px + CELL_SIZE / 2, py + CELL_SIZE / 2, CELL_SIZE / 2, Math.PI, Math.PI * 2);
                    ctx.lineTo(px + CELL_SIZE, py + CELL_SIZE);
                    ctx.lineTo(px, py + CELL_SIZE);
                    ctx.closePath();
                    ctx.fill();
                    
                    // ç»˜åˆ¶å¹½çµçœ¼ç›
                    ctx.fillStyle = '#FFF';
                    ctx.beginPath();
                    ctx.arc(px + CELL_SIZE / 3, py + CELL_SIZE / 2.5, CELL_SIZE / 6, 0, Math.PI * 2);
                    ctx.arc(px + CELL_SIZE * 2/3, py + CELL_SIZE / 2.5, CELL_SIZE / 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶å¹½çµçœ¼çƒ
                    ctx.fillStyle = '#000';
                    let eyeOffsetX = 0;
                    let eyeOffsetY = 0;
                    
                    switch (ghost.direction) {
                        case 'left': eyeOffsetX = -2; break;
                        case 'right': eyeOffsetX = 2; break;
                        case 'up': eyeOffsetY = -2; break;
                        case 'down': eyeOffsetY = 2; break;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(px + CELL_SIZE / 3 + eyeOffsetX, py + CELL_SIZE / 2.5 + eyeOffsetY, CELL_SIZE / 12, 0, Math.PI * 2);
                    ctx.arc(px + CELL_SIZE * 2/3 + eyeOffsetX, py + CELL_SIZE / 2.5 + eyeOffsetY, CELL_SIZE / 12, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            function update() {
                if (!gameRunning || gameOver) return;
                
                // ç§»åŠ¨åƒè±†äºº
                movePacman();
                
                // ç§»åŠ¨å¹½çµ
                moveGhosts();
                
                // æ£€æŸ¥ç¢°æ’
                checkCollisions();
                
                // æ›´æ–°å˜´å·´åŠ¨ç”»
                pacman.mouthOpen = !pacman.mouthOpen;
                
                // æ›´æ–°å¤§åŠ›ä¸¸è®¡æ—¶å™¨
                if (powerPelletActive) {
                    powerPelletTimer--;
                    if (powerPelletTimer <= 0) {
                        powerPelletActive = false;
                        for (const ghost of ghosts) {
                            ghost.isScared = false;
                        }
                    }
                }
                
                // ç»˜åˆ¶æ¸¸æˆ
                draw();
                
                // ç»§ç»­æ¸¸æˆå¾ªç¯
                if (gameRunning) {
                    animationFrameId = requestAnimationFrame(update);
                }
            }
            
            // ç§»åŠ¨åƒè±†äºº
            function movePacman() {
                // å°è¯•æ”¹å˜æ–¹å‘
                if (pacman.nextDirection !== pacman.direction) {
                    if (canMove(pacman.x, pacman.y, pacman.nextDirection)) {
                        pacman.direction = pacman.nextDirection;
                    }
                }
                
                // ç§»åŠ¨åƒè±†äºº
                if (canMove(pacman.x, pacman.y, pacman.direction)) {
                    switch (pacman.direction) {
                        case 'left': pacman.x -= PACMAN_SPEED / CELL_SIZE; break;
                        case 'right': pacman.x += PACMAN_SPEED / CELL_SIZE; break;
                        case 'up': pacman.y -= PACMAN_SPEED / CELL_SIZE; break;
                        case 'down': pacman.y += PACMAN_SPEED / CELL_SIZE; break;
                    }
                    
                    // å¤„ç†éš§é“
                    if (pacman.x < 0) pacman.x = GRID_WIDTH - 1;
                    if (pacman.x >= GRID_WIDTH) pacman.x = 0;
                    
                    // æ£€æŸ¥æ˜¯å¦åƒåˆ°è±†å­
                    checkDotCollision();
                }
            }
            
            // ç§»åŠ¨å¹½çµ
            function moveGhosts() {
                for (const ghost of ghosts) {
                    // ç®€å•AIï¼šéšæœºç§»åŠ¨ï¼Œä½†ä¸ä¼šåå‘
                    const directions = ['up', 'down', 'left', 'right'];
                    const possibleDirections = [];
                    
                    for (const dir of directions) {
                        // é¿å…åå‘ç§»åŠ¨
                        if ((dir === 'left' && ghost.direction === 'right') ||
                            (dir === 'right' && ghost.direction === 'left') ||
                            (dir === 'up' && ghost.direction === 'down') ||
                            (dir === 'down' && ghost.direction === 'up')) {
                            continue;
                        }
                        
                        if (canMove(ghost.x, ghost.y, dir)) {
                            possibleDirections.push(dir);
                        }
                    }
                    
                    if (possibleDirections.length > 0) {
                        // éšæœºé€‰æ‹©æ–¹å‘
                        const randomIndex = Math.floor(Math.random() * possibleDirections.length);
                        ghost.direction = possibleDirections[randomIndex];
                    }
                    
                    // ç§»åŠ¨å¹½çµ
                    switch (ghost.direction) {
                        case 'left': ghost.x -= ghost.speed / CELL_SIZE; break;
                        case 'right': ghost.x += ghost.speed / CELL_SIZE; break;
                        case 'up': ghost.y -= ghost.speed / CELL_SIZE; break;
                        case 'down': ghost.y += ghost.speed / CELL_SIZE; break;
                    }
                    
                    // å¤„ç†éš§é“
                    if (ghost.x < 0) ghost.x = GRID_WIDTH - 1;
                    if (ghost.x >= GRID_WIDTH) ghost.x = 0;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§»åŠ¨
            function canMove(x, y, direction) {
                let testX = Math.round(x);
                let testY = Math.round(y);
                
                // æ ¹æ®æ–¹å‘è°ƒæ•´æ£€æµ‹ç‚¹
                switch (direction) {
                    case 'left': testX -= 1; break;
                    case 'right': testX += 1; break;
                    case 'up': testY -= 1; break;
                    case 'down': testY += 1; break;
                }
                
                // è¾¹ç•Œæ£€æŸ¥
                if (testX < 0 || testX >= GRID_WIDTH || testY < 0 || testY >= GRID_HEIGHT) {
                    return true; // å…è®¸è¿›å…¥éš§é“
                }
                
                // å¢™å£æ£€æŸ¥
                return map[testY][testX] !== 1;
            }
            
            // æ£€æŸ¥è±†å­ç¢°æ’
            function checkDotCollision() {
                const gridX = Math.round(pacman.x);
                const gridY = Math.round(pacman.y);
                
                if (gridX >= 0 && gridX < GRID_WIDTH && gridY >= 0 && gridY < GRID_HEIGHT) {
                    if (map[gridY][gridX] === 2) {
                        // åƒåˆ°è±†å­
                        map[gridY][gridX] = 0;
                        score += 10;
                        dots--;
                        scoreElement.textContent = score;
                    } else if (map[gridY][gridX] === 3) {
                        // åƒåˆ°å¤§åŠ›ä¸¸
                        map[gridY][gridX] = 0;
                        score += 50;
                        dots--;
                        scoreElement.textContent = score;
                        
                        // æ¿€æ´»å¤§åŠ›ä¸¸æ•ˆæœ
                        powerPelletActive = true;
                        powerPelletTimer = POWER_PELLET_DURATION;
                        
                        for (const ghost of ghosts) {
                            ghost.isScared = true;
                        }
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦é€šå…³
                    if (dots === 0) {
                        levelUp();
                    }
                }
            }
            
            // æ£€æŸ¥ç¢°æ’
            function checkCollisions() {
                for (const ghost of ghosts) {
                    // è®¡ç®—åƒè±†äººå’Œå¹½çµä¹‹é—´çš„è·ç¦»
                    const dx = Math.abs(pacman.x - ghost.x);
                    const dy = Math.abs(pacman.y - ghost.y);
                    
                    if (dx < 0.8 && dy < 0.8) {
                        if (powerPelletActive && ghost.isScared) {
                            // åƒæ‰å¹½çµ
                            score += 200;
                            scoreElement.textContent = score;
                            
                            // é‡ç½®å¹½çµä½ç½®
                            ghost.x = Math.floor(GRID_WIDTH / 2);
                            ghost.y = Math.floor(GRID_HEIGHT / 2);
                            ghost.isScared = false;
                        } else {
                            // è¢«å¹½çµæŠ“åˆ°
                            loseLife();
                        }
                    }
                }
            }
            
            // å‡çº§
            function levelUp() {
                level++;
                levelElement.textContent = level;
                
                // é‡æ–°åŠ è½½å…³å¡ï¼Œå¢åŠ éš¾åº¦
                loadLevel();
                
                // å¢åŠ å¹½çµé€Ÿåº¦
                for (const ghost of ghosts) {
                    ghost.speed = GHOST_SPEED + (level * 0.1);
                }
            }
            
            // å¤±å»ç”Ÿå‘½
            function loseLife() {
                lives--;
                livesElement.textContent = lives;
                
                if (lives <= 0) {
                    // æ¸¸æˆç»“æŸ
                    gameOver = true;
                    gameRunning = false;
                    alert(`æ¸¸æˆç»“æŸ! ä½ çš„å¾—åˆ†: ${score}`);
                } else {
                    // é‡ç½®åƒè±†äººå’Œå¹½çµä½ç½®
                    loadLevel();
                }
            }
            
            // å¼€å§‹æ¸¸æˆ
            function startGame() {
                if (!gameRunning && !gameOver) {
                    gameRunning = true;
                    startBtn.disabled = true;
                    pauseBtn.disabled = false;
                    animationFrameId = requestAnimationFrame(update);
                }
            }
            
            // æš‚åœæ¸¸æˆ
            function pauseGame() {
                if (gameRunning) {
                    gameRunning = false;
                    cancelAnimationFrame(animationFrameId);
                    pauseBtn.textContent = "ç»§ç»­";
                } else {
                    gameRunning = true;
                    pauseBtn.textContent = "æš‚åœ";
                    animationFrameId = requestAnimationFrame(update);
                }
            }
            
            // é‡ç½®æ¸¸æˆ
            function resetGame() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                initGame();
            }
            
            // é”®ç›˜æ§åˆ¶
            document.addEventListener('keydown', (e) => {
                if (!gameRunning && e.keyCode !== 32) return;
                
                switch(e.keyCode) {
                    case 37: // Left arrow
                    case 65: // A
                        pacman.nextDirection = 'left';
                        break;
                    case 39: // Right arrow
                    case 68: // D
                        pacman.nextDirection = 'right';
                        break;
                    case 38: // Up arrow
                    case 87: // W
                        pacman.nextDirection = 'up';
                        break;
                    case 40: // Down arrow
                    case 83: // S
                        pacman.nextDirection = 'down';
                        break;
                    case 32: // Space
                        if (!gameRunning && !gameOver) {
                            startGame();
                        }
                        break;
                    case 80: // P key
                        if (gameRunning || pauseBtn.textContent === "ç»§ç»­") {
                            pauseGame();
                        }
                        break;
                }
            });
            
            // ç§»åŠ¨ç«¯æ§åˆ¶
            upBtn.addEventListener('click', () => pacman.nextDirection = 'up');
            downBtn.addEventListener('click', () => pacman.nextDirection = 'down');
            leftBtn.addEventListener('click', () => pacman.nextDirection = 'left');
            rightBtn.addEventListener('click', () => pacman.nextDirection = 'right');
            
            // æŒ‰é’®äº‹ä»¶ç›‘å¬
            startBtn.addEventListener('click', startGame);
            pauseBtn.addEventListener('click', pauseGame);
            resetBtn.addEventListener('click', resetGame);
            
            // åˆå§‹ç»˜åˆ¶
            initGame();
        });
    </script>
</body>
</html>
